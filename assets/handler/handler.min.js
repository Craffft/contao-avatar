/**
 * avatar extension for Contao Open Source CMS
 *
 * @copyright  Copyright (c) 2008-2014, terminal42 gmbh
 * @author     terminal42 gmbh <info@terminal42.ch>
 * @license    http://opensource.org/licenses/lgpl-3.0.html LGPL
 * @link       http://github.com/terminal42/contao-avatar
 */
;jQuery.noConflict(),function(a){"use strict";var c,d,e,b={backend:!1},f="",g=!1,h=function(){e=new qq.FineUploader({element:c.find(".upload_container")[0],debug:!1,multiple:!1,request:{endpoint:window.location.href,inputName:b.field+"_upload",params:{action:"avatar_upload",name:b.field,REQUEST_TOKEN:b.request_token}},failedUploadTextDisplay:{mode:"custom",maxChars:1e3,responseProperty:"error"},validation:{allowedExtensions:b.extensions,sizeLimit:b.sizeLimit},text:{formatProgress:b.labels.text.formatProgress,failUpload:b.labels.text.failUpload,waitingForResponse:b.labels.text.waitingForResponse,paused:b.labels.text.paused},messages:{tooManyFilesError:b.labels.messages.tooManyFilesError,unsupportedBrowser:b.labels.messages.unsupportedBrowser},retry:{autoRetryNote:b.labels.retry.autoRetryNote},deleteFile:{confirmMessage:b.labels.deleteFile.confirmMessage,deletingStatusText:b.labels.deleteFile.deletingStatusText,deletingFailedText:b.labels.deleteFile.deletingFailedText},paste:{namePromptMessage:b.labels.paste.namePromptMessage},callbacks:{onUpload:function(){g&&AjaxRequest.displayBox(Contao.lang.loading+" …")},onComplete:function(d,e,h){return h.success?(f=h.file,void a.ajax({url:window.location.href,data:{action:"avatar_reload",name:b.field,value:f,REQUEST_TOKEN:b.request_token},type:"POST",complete:function(a){g&&(AjaxRequest.hideBox(),window.fireEvent("ajax_change"))},success:function(a){c.find(".ajax_container").html(a),i(),j()}})):void(g&&AjaxRequest.hideBox())}}})},i=function(){var d;c.find(".thumbnail").Jcrop({allowResize:!0,allowSelect:!1,aspectRatio:b.avatarSize[0]/b.avatarSize[1],minSize:[b.avatarSize[0],b.avatarSize[1]],setSelect:[0,0,b.avatarSize[0],b.avatarSize[1]]},function(){d=this}),c.find(".crop_link").on("click",function(e){e.preventDefault();var h=d.tellSelect();a.ajax({url:window.location.href,data:{action:"avatar_reload",name:b.field,value:f,crop:h.x+","+h.y+","+h.w+","+h.h,REQUEST_TOKEN:b.request_token},type:"POST",beforeSend:function(){g&&AjaxRequest.displayBox(Contao.lang.loading+" …")},complete:function(a){g&&(AjaxRequest.hideBox(),window.fireEvent("ajax_change"))},success:function(a){c.find(".ajax_container").html(a),j()}})})},j=function(){c.find(".delete_link").on("click",function(a){a.preventDefault(),k()})},k=function(){d.val(""),c.find(".work_container").html("")};a.fn.Avatar=function(e){return a.extend(b,e),c=a(this),h(),d=a("#ctrl_"+b.field),b.backend&&(g=!0),f=d.val(),""!=f&&j(),this}}(jQuery);